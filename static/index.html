<html>
    <head>
        <title>
            /r/Steam Recommendations
        </title>

        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z" crossorigin="anonymous">

        <script src="https://code.jquery.com/jquery-3.5.1.min.js" crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js" integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN" crossorigin="anonymous"></script>
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js" integrity="sha384-B4gt1jrGC7Jh4AgTPSdUtOBvfO8shuf57BaghqFfPlYxofvL8/KUEfYiJOMMV+rV" crossorigin="anonymous"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/2.0.11/purify.min.js"></script>

        <style type="text/css">
          @media only screen and (min-width: 1560px) {
            #selectors {
              position: fixed;
              left: 1em;
              top: calc(56px + 0.5em);
              width: calc(25% - 1em);

              height: calc(100vh - 56px - 1em);
            }

            #apps {
              position: absolute;
              right: 1em;
              top: calc(56px + 0.5em);
              width: calc(75% - 1em);

              height: 100%;
            }
          }

          @media only screen and (max-width: 1560px) {
            #selectors {
              margin-top: calc(56px + 0.5em);
              margin-bottom: 0.5em;
            }

            #apps {
              margin: 0 auto;
            }
          }
        </style>

        <script>
          let apps;
          const country = "fr";
          const currency = "EUR";

          function refreshApps(apps){
            let html = "";

            for( app in apps ){
              app = apps[app];

              console.log(app);
              
              let appPrice;
              if( app.price != null ) appPrice = `<a class="btn btn-sm btn-outline-primary" href="${app.price.url}">${app.price.provider} (${app.price.discount > 0 ? "-" + app.price.discount + "% " : ""}${currency}${app.price.price/100})</a>`;
              else appPrice = "(unavailable)";

              html += `
              <div class="col-sm-12 col-md-6 col-lg-3">
                <div class="card mb-4 shadow-sm ${app.genres.indexOf("Early Access") > -1 ? "early-access": ""}">
                  <img class="ea-ribbon" src="https://s3.cutie.cafe/recommendations/early_access.png" style="top: 0; left: 0; position: absolute; width: 40%; display: ${app.genres.indexOf("Early Access") > -1 ? "block" : "none"}">
                  <div class="card-img-top minitrailer" data-video="${app.video}" data-capsule="https://steamcdn-a.akamaihd.net/steam/apps/${app.appid}/header.jpg" width="100%">
                    <img data-appid="${app.appid}" width="100%" src="https://steamcdn-a.akamaihd.net/steam/apps/${app.appid}/header.jpg?t=${Date.now()}"></img>
                  </div>
                  <div class="card-body">
                    <h5 class="card-title">
                      ${DOMPurify.sanitize(app.name)} (${app.release_year})<br>
                      <small class="text-muted">${DOMPurify.sanitize(app.developers[0] == app.publishers[0] ? app.developers[0] : app.developers[0] + "; " + app.publishers[0])}</small>
                    </h5>
                    <p class="card-text">
                      ${app.genres.filter(i => i != "Early Access").map(i => "<a class='badge badge-info' class='tag' href='#tag=" + DOMPurify.sanitize(i) + "'>" + DOMPurify.sanitize(i) + "</a>").join(" ")}<br>

                      ${DOMPurify.sanitize(app.description)}
                    </p>
                    <div class="d-flex justify-content-between align-items-center">
                      <div class="btn-group">
                        ${appPrice}
                      </div>
                      <small class="text-muted" style="text-align: right;"><a href="https://store.steampowered.com/app/${app.appid}" target="_blank">View on Steam</a><br>${/* app.platforms.split("").map(i => platDecode[i]).join(" ") */ ""}</small>
                    </div>
                  </div>
                </div>
              </div>
              `;
            }

            document.querySelector("#apps").innerHTML = html;
          }

          window.addEventListener("load", async () => {
            apps = await (await fetch("/api/suggestions")).json();

            for( app in apps ){
              app = apps[app];

              app.price = app.prices[Object.keys(app.prices).sort((j, k) => {
                if( app.prices[j] && app.prices[j][country] ) app.prices[j][country].provider = j;
                if( app.prices[k] && app.prices[k][country] ) app.prices[k][country].provider = k;

                if( ! app.prices[j] || ! app.prices[j][country] ) return 1;
                if( ! app.prices[k] || ! app.prices[k][country] ) return -1;

                if( app.prices[j][country].price < app.prices[k][country].price ) return -1;
                else if( app.prices[j][country].price > app.prices[k][country].price ) return 1;
                else return 0;
              })[0]];

              if( app.price != null ) app.price = app.price[country];

              console.log(app.price);
            }

            refreshApps(apps);
          });
        </script>
      </head>
    <body>
        <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
            <a class="navbar-brand" href="#">/r/Steam Recommendations</a>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
              <span class="navbar-toggler-icon"></span>
            </button>
          
            <div class="collapse navbar-collapse" id="navbar">
              <ul class="navbar-nav mr-auto">
                <li class="nav-item active">
                  <a class="nav-link" href="#">Home</a>
                </li>
                <li class="nav-item">
                  <a class="nav-link" href="#">Link</a>
                </li>
                <li class="nav-item">
                  <a class="nav-link disabled" href="#" tabindex="-1" aria-disabled="true">Disabled</a>
                </li>
                <li class="nav-item dropdown">
                  <a class="nav-link dropdown-toggle" href="#" id="dropdown05" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Dropdown</a>
                  <div class="dropdown-menu" aria-labelledby="dropdown05">
                    <a class="dropdown-item" href="#">Action</a>
                    <a class="dropdown-item" href="#">Another action</a>
                    <a class="dropdown-item" href="#">Something else here</a>
                  </div>
                </li>
              </ul>
              <div class="my-2 my-md-0">
                <a class="btn btn-primary" href="https://www.reddit.com/r/Steam" target="_blank">Visit /r/Steam</a>
              </div>
            </div>
          </nav>

          <div id="selectors">
            <h3>Filters</h3>

            <select id="select_tag" class="form-control">
              <option value="" disabled selected>Select a genre...</option>
            </select>

            <hr>

            <div class="col input-group">
                <div class="input-group-prepend">
                    <span class="input-group-text">Under <span class="currency"></span></span>
                </div>
                <input type="number" id="max-cost" class="form-control">
            </div>
          </div>

          <div id="apps" class="row">

          </div>
    </body>
</html>